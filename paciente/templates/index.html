{% extends 'base.html' %}
{% load static %}
{% load bootstrap4 %}
{# CSS Bootstrap #}
{% bootstrap_css %}
{% block extrahead %}
<link rel="icon" type="image/png" href="{% static path %}images/icons/favicon.ico"/>
<link rel="stylesheet" type="text/css" href="{% static path %}vendor/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="{% static path %}fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="{% static path %}vendor/animate/animate.css">
<link rel="stylesheet" type="text/css" href="{% static path %}vendor/select2/select2.min.css">
<link rel="stylesheet" type="text/css" href="{% static path %}vendor/perfect-scrollbar/perfect-scrollbar.css">
<link rel="stylesheet" type="text/css" href="{% static path %}css/util.css">
<link rel="stylesheet" type="text/css" href="{% static path %}css/main.css">
{% endblock extrahead %}
{% block titulo %}Index{% endblock titulo %}
{% block h1 %}Página Principal{% endblock h1 %}
{% block cuerpo %}
<br>
<form id="form_lugarAtencion" method="POST">
    {% csrf_token %}
  <div style="display: flex;justify-content: center;" >
    <select name="lugarAtencion" id="lugarAtencion" onchange="cambiaSelect()" style="width: 290px;"class="select-css">
      <option value="0">Seleccione Lugar de Atenci&oacute;n</option>
      <option value="1">Clinica</option>
      <option value="2">Domicilio</option>
    </select>
  </div>

  <div class="container">
    <div class="row">
        <div class="col-md-12 search">
                <div id="custom-search-input">
                    <div class="input-gorup col-md-12">
                        <input type="text" class="form-control" placeholder="Buscar" id="buscar" name="buscar" oninput="cambiaSelect()">
                        <span class="input-group-list">
                        </span>
                    </div>
                </div>
        </div>
    </div>
</div>
</form>
<section>
    <div class="limiter">
        <div class="container-table100">
            <div class="wrap-table100">

                <div class="table100 ver5 m-b-110">
                    <div class="table100-head">
                        <table>
                            <thead>
                                <tr class="row100 head">
                                    <th class="cell100 column2">Rut</th>
                                    <th class="cell100 column2">Nombres</th>
                                    <th class="cell100 column2">Apellidos</th>
                                    <th class="cell100 column2">Opciones</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <div class="table100-body js-pscroll">
                        <table>
                            <tbody id="cuerpoTabla">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" name="user" id="user" value="{{ user.id}}">
</section>

<script src="{% static path %}vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="{% static path %}vendor/bootstrap/js/popper.js"></script>
<script src="{% static path %}vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="{% static path %}vendor/select2/select2.min.js"></script>
<script src="{% static path %}vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script>
//script para prevenir enviar form con ENTER
$("form").bind("keypress", function (e) {
    if (e.keyCode == 13) {
        $("#btnSearch").attr('value');
        //add more buttons here
        return false;
    }
});

function eliminarPaciente(id){
    if(confirm('¿Está seguro que desea eliminar?')){
        alert("Paciente eliminado correctamente")
        location.href="eliminarpaciente/"+id
    }

}
function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}
function cambiaSelect(){
    var form = new FormData(document.getElementById("form_lugarAtencion"));
    valorSelect = document.getElementById("lugarAtencion").value
    valorBuscar = document.getElementById("buscar").value
    var cuerpo = document.getElementById("cuerpoTabla")
    if(valorSelect != '0'){
        cuerpo.innerHTML = ""
    }
    $.ajax({
        url: "/",
        type: 'POST',
        data: {id: valorSelect, buscar:valorBuscar},
        dataType: 'json'
    }).done(function(data){
        for (let i in data) {
            for (let j in data[i]) {
                if (data[i][j]) {
                    var lugarAtencion 
                    if (data[i][j].lugarAtencion_id == '1'){
                        lugarAtencion = "Clínica"
                    }
                    if(data[i][j].lugarAtencion_id == '2'){
                        lugarAtencion = "Domicilio"
                    }
                    cuerpo.innerHTML+=`
                    <tr>
                        <td class="cell100 column2">`+data[i][j].rut+`</td>
                        <td class="cell100 column2">`+data[i][j].pnombre+" "+ data[i][j].snombre+`</td>
                        <td class="cell100 column2">`+data[i][j].papellido+" "+ data[i][j].sapellido+`</td>
                        <td class="cell100 column2"><button type="button" class="btn-historial" style="width:100%;"><a href="#openModal">Ver Acciones</a></button>
                            <div id="openModal" class="modalDialog">
                                <div>
                                    <a href="#close" title="Cerrar" class="close">X</a>
                                    <button type="button" class="btn-historial" style="background-color: #e3f2fd;color:black;" onclick="window.location.href='/historial/`+data[i][j].rut+`'">Historial</button>
                                    <button type="button" class="btn-historial" style="background-color: #e3f2fd;color:black;" onclick="window.location.href='/SignosVitales/`+data[i][j].rut+`'">Signos Vitales</button>
                                    <button type="button" class="btn-historial" style="background-color: #e3f2fd;color:black;" onclick="window.location.href='/Evolucion/`+data[i][j].rut+`'">Evolucion Cuidador</button>
                                </div>
                            </div>{% if request.user.is_staff %}<button type="button" style="color:black;width:100%" class="btn-historial" onclick="window.location.href='editarpaciente/`+data[i][j].rut+`'">Editar</button><button type="button" style="color:black;width:100%" onclick="eliminarPaciente('`+data[i][j].rut+`')" class="btn-historial">Eliminar</button>{% endif %}</td>
                    </tr>`
                }
            }
        }
    }).fail(function (data){
        alert('error al cargar datos')
    })

}

$('.js-pscroll').each(function(){
                var ps = new PerfectScrollbar(this);
                $(window).on('resize', function(){
                    ps.update();
                })
            });
</script>
<script src="../static/js/main.js"></script>
{% endblock %}